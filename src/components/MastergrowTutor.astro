---
import Layout from '../layouts/Layout.astro';
---

<Layout title="MasterGrower Tutor">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-green-700">MasterGrower Tutor</h1>

    <div class="grid md:grid-cols-[1fr,1.5fr] gap-6">
      <!-- Formulario de preguntas -->
      <div class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4 text-green-600">Nueva Consulta</h2>
        <form id="tutorForm" class="flex flex-col gap-4">
          <div>
            <label for="userMessage" class="block font-medium text-gray-700 mb-2">
              ¿Qué quieres saber sobre tus plantas?
            </label>
            <textarea
              name="userMessage"
              id="userMessage"
              placeholder="Ej. ¿Cómo puedo mejorar el riego de mis plantas?"
              required
              class="w-full border border-gray-300 rounded-md p-3 min-h-[120px] focus:ring-2 focus:ring-green-500 focus:border-transparent"
              rows="4"
            ></textarea>
          </div>

          <button
            type="submit"
            class="bg-green-600 text-white rounded-md py-2 px-4 font-medium hover:bg-green-700 transition-colors duration-200 flex items-center justify-center"
          >
            <span id="buttonText">Enviar consulta</span>
            <span id="loadingSpinner" class="hidden">
              <svg class="animate-spin h-5 w-5 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </form>
      </div>

      <!-- Conversación actual -->
      <div class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4 text-green-600">Conversación Actual</h2>
        <div
          id="conversation"
          class="border border-gray-200 rounded-md p-4 min-h-[200px] max-h-[400px] overflow-y-auto space-y-4"
        >
          <p class="text-gray-500 text-center italic">Aún no hay mensajes en esta conversación.</p>
        </div>
      </div>

      <!-- Historial de conversaciones -->
      <div class="md:col-span-2 bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4 text-green-600">Historial de Conversaciones</h2>
        <div id="conversationHistory" class="space-y-4">
          <p class="text-gray-500 text-center italic">Cargando historial...</p>
        </div>
      </div>
    </div>
  </div>

<script is:inline>
// Actualizar la función de envío en el script
let currentThreadId = null;

async function handleSubmit(event) {
  event.preventDefault();
  if (isSubmitting) return;
  
  isSubmitting = true;
  toggleLoadingState(true);
  const conversationEl = document.getElementById('conversation');
  const userMessage = document.getElementById('userMessage').value;

  try {
    const res = await fetch('/api/mastergrow-tutor', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        userMessage,
        threadId: currentThreadId // Incluir el ID del thread si existe
      }),
    });

    if (!res.ok) throw new Error(await res.text());

    const { messages, threadId } = await res.json();
    currentThreadId = threadId; // Guardar el ID del thread para futuros mensajes
    
    // Mostrar los mensajes
    conversationEl.innerHTML = messages.map(msg => `
      <div class="bg-${msg.role === 'user' ? 'green' : 'gray'}-50 p-3 rounded-md">
        <div class="font-semibold text-green-700">
          ${msg.role === 'user' ? 'Tú' : 'Asistente'}:
        </div>
        <div>${msg.content}</div>
      </div>
    `).join('');

    document.getElementById('userMessage').value = '';
    await loadConversationHistory();
    
  } catch (error) {
    console.error('Error:', error);
    conversationEl.innerHTML += `
      <div class="bg-red-50 p-3 rounded-md text-red-700">
        Error: No se pudo procesar tu consulta. Por favor, intenta nuevamente.
      </div>
    `;
  } finally {
    isSubmitting = false;
    toggleLoadingState(false);
    conversationEl.scrollTop = conversationEl.scrollHeight;
  }
}
</script>
</Layout>