---
import { authenticate } from "../../lib/auth";
import { supabase } from "../../lib/supabase";

const { user, redirect } = await authenticate(Astro);
if (redirect) {
    return Astro.redirect(redirect);
}

// Obtenemos el device_id y device_name
const { data: tuya_devices } = await supabase
  .from("tuya_devices")
  .select("*")
  .eq("user_id", user.id)
  .single();

const device_id = tuya_devices?.device_id ?? "";  
const device_name = tuya_devices?.device_name ?? "";

// Hacemos fetch con el device_id al endpoint /api/tuya/status
let deviceInfo = null;

if (device_id) {
  const res = await fetch(`http://localhost:4321/api/tuya/status?deviceId=${device_id}`);
  if (res.ok) {
    deviceInfo = await res.json();
  } else {
    console.error("No se pudo obtener la informaciÃ³n del dispositivo", await res.json());
  }
}

// Normalizar temperatura y humedad
const normalizeTemperature = (value) => value / 10;
const getValueByCode = (code) => deviceInfo?.deviceStatus.find(x => x.code === code)?.value ?? null;

const temperature = normalizeTemperature(getValueByCode('va_temperature'));
const humidity = getValueByCode('va_humidity');
const battery = getValueByCode('battery_percentage');

// CÃ¡lculo de Dew Point (Punto de RocÃ­o) usando fÃ³rmula de Magnus-Tetens
const calculateDewPoint = (temp, hum) => {
  const A = 17.27;
  const B = 237.7;
  const alpha = (A * temp) / (B + temp) + Math.log(hum / 100);
  return (B * alpha) / (A - alpha);
};

// CÃ¡lculo del VPD (DÃ©ficit de PresiÃ³n de Vapor) en kPa
const calculateVPD = (temp, hum) => {
  const es = 0.6108 * Math.exp((17.27 * temp) / (237.7 + temp));  // PresiÃ³n de vapor de saturaciÃ³n
  const ea = es * (hum / 100);                                    // PresiÃ³n de vapor actual
  return es - ea;
};

const dewPoint = calculateDewPoint(temperature, humidity).toFixed(2);
const vpd = calculateVPD(temperature, humidity).toFixed(2);
---

<h1>Estado del Dispositivo</h1>
<p><strong>Device Name:</strong> {device_name}</p>
<p><strong>Device ID:</strong> {device_id}</p>

<!-- RenderizaciÃ³n de valores con cÃ¡lculo actualizado -->
{deviceInfo && deviceInfo.deviceStatus ? (
    <ul>
        <li>ğŸŒ¡ï¸ Temperatura: {temperature.toFixed(1)} Â°C</li>
        <li>ğŸ’§ Humedad: {humidity}%</li>
        <li>ğŸ”‹ BaterÃ­a: {battery}%</li>
        <li>ğŸŒ¡ï¸ Punto de RocÃ­o (Dewpoint): {dewPoint} Â°C</li>
        <li>ğŸ’¨ VPD: {vpd} kPa</li>
    </ul>
) : (
    <p>No hay datos disponibles o error al cargar.</p>
)}
