---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

let sessionData;
try {
  const { data, error } = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (error) throw error;
  sessionData = data;
} catch (error) {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/signin");
}

if (!sessionData.user) {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/signin");
}

// Obtener o crear el perfil
const user = sessionData.user;
const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("user_id", user.id)
  .single();

// Cada campo vendrá desde "profile" si existe, sino default a ""
const user_name = profile?.user_name ?? "";
const experience_level = profile?.experience_level ?? "";
const comuna = profile?.comuna ?? "";
const cultivo_principal = profile?.cultivo_principal ?? "";
const escala_cultivo = profile?.escala_cultivo ?? "";
const motivacion = profile?.motivacion ?? "";
const tamano_espacio = profile?.tamano_espacio ?? "";
const tipo_suelo = profile?.tipo_suelo ?? "";
const tipo_iluminacion = profile?.tipo_iluminacion ?? "";
const fuente_riego = profile?.fuente_riego ?? "";
const fertilizacion = profile?.fertilizacion ?? "";
const control_plagas = profile?.control_plagas ?? "";
const frecuencia_riego = profile?.frecuencia_riego ?? "";
const problemas_enfrentados = profile?.problemas_enfrentados ?? "";
const objetivos_mejora = profile?.objetivos_mejora ?? "";
const interes_tecnologia = profile?.interes_tecnologia ?? "";
---


---

<Layout title="Perfil">
<!-- Contenedor principal -->
<div class="max-w-2xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-6">Completa tu perfil</h1>
      <!-- Mostramos el email desde la sesión (auth.users) -->
      <p class="mb-6">Correo electrónico: <strong>{user.email}</strong></p>

  <!-- Formulario que envía los datos a /api/profile vía POST -->
  <form 
    action="/api/profile" 
    method="POST" 
    class="space-y-8 bg-white p-6 rounded-md shadow-md"
  >
    <!-- Sección: Datos personales básicos -->
    <section>
      <h2 class="text-xl font-semibold mb-4">Datos personales</h2>

      <div class="mb-4">
        <label 
          for="user_name" 
          class="block mb-1 font-medium text-gray-700"
        >
          Nombre de usuario
        </label>
        <input
          type="text"
          id="user_name"
          name="user_name"
          value={user_name}
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        />
      </div>

      <div class="mb-4">
        <label 
          for="experience_level" 
          class="block mb-1 font-medium text-gray-700"
        >
          Nivel de experiencia en jardinería o agricultura
        </label>
        <select
          id="experience_level"
          name="experience_level"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
        <option value="">
          {experience_level === "" ? "Selecciona una opción" : experience_level}
        </option>
          <option value="Principiante">Principiante</option>
          <option value="Intermedio">Intermedio</option>
          <option value="Avanzado">Avanzado</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="comuna" 
          class="block mb-1 font-medium text-gray-700"
        >
          Comuna de residencia
        </label>
        <input
          type="text"
          id="comuna"
          name="comuna"
          value={comuna}
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        />
      </div>
    </section>

    <!-- Sección: Objetivo u orientación del cultivo -->
    <section>
      <h2 class="text-xl font-semibold mb-4">Objetivo del cultivo</h2>

      <div class="mb-4">
        <label 
          for="cultivo_principal" 
          class="block mb-1 font-medium text-gray-700"
        >
          Tipo de cultivo principal
        </label>
        <select
          id="cultivo_principal"
          name="cultivo_principal"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {cultivo_principal === "" ? "Selecciona una opción" : cultivo_principal}
          </option>
          <option value="Cannabis">Cannabis</option>
          <option value="Hortalizas">Hortalizas</option>
          <option value="Frutales">Frutales</option>
          <option value="Flores">Flores</option>
          <option value="Plantas ornamentales">Plantas ornamentales</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="escala_cultivo" 
          class="block mb-1 font-medium text-gray-700"
        >
          Escala de cultivo
        </label>
        <select
          id="escala_cultivo"
          name="escala_cultivo"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {escala_cultivo === "" ? "Selecciona una opción" : escala_cultivo}
          </option>
          <option value="Doméstico">Doméstico</option>
          <option value="Producción comercial">Producción comercial</option>
          <option value="Producción medicinal">Producción medicinal</option>
          <option value="Jardín urbano">Jardín urbano</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="motivacion" 
          class="block mb-1 font-medium text-gray-700"
        >
          Motivación o meta
        </label>
        <select
          id="motivacion"
          name="motivacion"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {motivacion === "" ? "Selecciona una opción" : motivacion}
          </option>
          <option value="Autoconsumo">Autoconsumo</option>
          <option value="Venta">Venta</option>
          <option value="Investigación">Investigación</option>
          <option value="Hobbies">Hobbies</option>
          <option value="Conservación">Conservación</option>
        </select>
      </div>
    </section>

    <!-- Sección: Condiciones del espacio y medio de cultivo -->
    <section>
      <h2 class="text-xl font-semibold mb-4">Condiciones del espacio y medio de cultivo</h2>

      <div class="mb-4">
        <label 
          for="tamano_espacio" 
          class="block mb-1 font-medium text-gray-700"
        >
          Tamaño de espacio disponible (m², macetas, etc.)
        </label>
        <input
          type="text"
          id="tamano_espacio"
          name="tamano_espacio"
          value={tamano_espacio}
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        />
      </div>

      <div class="mb-4">
        <label 
          for="tipo_suelo" 
          class="block mb-1 font-medium text-gray-700"
        >
          Tipo de suelo o sustrato
        </label>
        <select
          id="tipo_suelo"
          name="tipo_suelo"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {tipo_suelo === "" ? "Selecciona una opción" : tipo_suelo}
          </option>
          <option value="Light Mix">Light Mix</option>
          <option value="Fibra de coco">Fibra de coco</option>
          <option value="Compost">Compost</option>
          <option value="Sustratos especializados">Sustratos especializados</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="tipo_iluminacion" 
          class="block mb-1 font-medium text-gray-700"
        >
          Tipo de iluminación
        </label>
        <select
          id="tipo_iluminacion"
          name="tipo_iluminacion"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {tipo_iluminacion === "" ? "Selecciona una opción" : tipo_iluminacion}
          </option>
          <option value="Solar">Solar</option>
          <option value="Luz Led">Luz Led</option>
          <option value="HPS">HPS</option>
          <option value="LEC">LEC</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="fuente_riego" 
          class="block mb-1 font-medium text-gray-700"
        >
          Fuente de riego
        </label>
        <select
          id="fuente_riego"
          name="fuente_riego"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {fuente_riego === "" ? "Selecciona una opción" : fuente_riego}
          </option>
          <option value="Agua de pozo">Agua de pozo</option>
          <option value="Agua de lluvia">Agua de lluvia</option>
          <option value="Red pública">Red pública</option>
          <option value="Riego por goteo">Riego por goteo</option>
          <option value="Aspersión">Aspersión</option>
        </select>
      </div>
    </section>

    <!-- Sección: Prácticas agrícolas o de jardinería -->
    <section>
      <h2 class="text-xl font-semibold mb-4">Prácticas agrícolas o de jardinería</h2>

      <div class="mb-4">
        <label 
          for="fertilizacion" 
          class="block mb-1 font-medium text-gray-700"
        >
          Métodos de fertilización
        </label>
        <select
          id="fertilizacion"
          name="fertilizacion"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {fertilizacion === "" ? "Selecciona una opción" : fertilizacion}
          </option>
          <option value="Abonos orgánicos">Abonos orgánicos</option>
          <option value="Fertilizantes químicos">Fertilizantes químicos</option>
          <option value="Combinación">Combinación</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="control_plagas" 
          class="block mb-1 font-medium text-gray-700"
        >
          Prácticas de control de plagas y enfermedades 
        </label>       
        <select
          id="control_plagas"
          name="control_plagas"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {control_plagas === "" ? "Selecciona una opción" : control_plagas}
          </option>
          <option value="Métodos ecológicos">Métodos ecológicos</option>
          <option value="Uso de pesticidas">Uso de pesticidas</option>
          <option value="Control biológico">Control biológico</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="frecuencia_riego" 
          class="block mb-1 font-medium text-gray-700"
        >
          Frecuencia de riego y cuidados
        </label>
        <select
          id="frecuencia_riego"
          name="frecuencia_riego"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {frecuencia_riego === "" ? "Selecciona una opción" : frecuencia_riego}
          </option>
          <option value="Diaria">Diaria</option>
          <option value="Semanal">Semanal</option>
          <option value="Según estación">Según estación</option>
        </select>
      </div>
    </section>

    <!-- Sección: Intereses y desafíos específicos -->
    <section>
      <h2 class="text-xl font-semibold mb-4">Intereses y desafíos específicos</h2>

      <div class="mb-4">
        <label 
          for="problemas_enfrentados" 
          class="block mb-1 font-medium text-gray-700"
        >
          Principales problemas enfrentados
        </label>
        <select
          id="problemas_enfrentados"
          name="problemas_enfrentados"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {problemas_enfrentados === "" ? "Selecciona una opción" : problemas_enfrentados}
          </option>
          <option value="Falta de tiempo">Falta de tiempo</option>
          <option value="Plagas específicas">Plagas específicas</option>
          <option value="Malezas">Malezas</option>
          <option value="Variaciones climáticas">Variaciones climáticas</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="objetivos_mejora" 
          class="block mb-1 font-medium text-gray-700"
        >
          Objetivos de mejora
        </label>
        <select
          id="objetivos_mejora"
          name="objetivos_mejora"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {objetivos_mejora === "" ? "Selecciona una opción" : objetivos_mejora}
          </option>
          <option value="Aumento de la producción">Aumento de la producción</option>
          <option value="Mejorar la calidad de producción">Mejorar la calidad de producción</option>
          <option value="Sostenibilidad">Sostenibilidad</option>
          <option value="Embellecimiento del espacio">Embellecimiento del espacio</option>
        </select>
      </div>

      <div class="mb-4">
        <label 
          for="interes_tecnologia" 
          class="block mb-1 font-medium text-gray-700"
        >
          Interés en tecnología agrícola
        </label>
        <select
          id="interes_tecnologia"
          name="interes_tecnologia"
          required
          class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white"
        >
          <option value="">
            {interes_tecnologia === "" ? "Selecciona una opción" : interes_tecnologia}
          </option>
          <option value="Monitoreo de cultivos">Monitoreo de cultivos</option>
          <option value="Sistemas de riego automatizado">Sistemas de riego automatizado</option>
          <option value="Sensores de humedad">Sensores de humedad</option>
        </select>
      </div>
    </section>

    <!-- Botón para enviar el formulario -->
    <button
      type="submit"
      class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md"
    >
      Actualizar perfil
    </button>
  </form>
</div>

<Layout/>